{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="admin-container">
    <div class="admin-card">
      <div class="sticky-sync-wrapper">
        <button type="button" class="btn-back-big" onclick="window.location.href='{% url 'administrar-productos' %}'" aria-label="Volver">‚Üê</button>
        <div class="slide" id="slideSync">
          <img src="{% static 'img/logo-dotapp-sena.png' %}" alt="Logo DotApp SENA" class="logo" />
          <h1>Gesti√≥n de Palabras</h1>
          <p>Agrega nuevos tipos, tallas o colores de producto.</p>
          <p>Puedes agregar nuevos centros o programas de formaci√≥n.</p>

          <div class="btn-container">
            <!-- Bot√≥n para abrir el modal de configuracion de productos -->
            <button id="btnAbrirConfiguraciones" class="btn-config">
              ‚öôÔ∏è Configuraciones de Producto
            </button>

            <!-- Bot√≥n para abrir el modal de configuraciones Adicionales -->
            <button id="btnAbrirConfiguracionesAdicionales" class="btn-config">
              ‚öôÔ∏è Configuraciones Adicionales
            </button>
          </div>
          <br><br>

          <div class="filtros">
              <input type="text" id="txt_palabra" placeholder="Buscar palabra" />
              
              <select id="selTabla">
                  <option value="">Seleccione una tabla</option>
                  <option value="centros">Centros</option>
                  <option value="programas">Programas</option>
                  <option value="tipos">Tipos de producto</option>
                  <option value="tallas">Tallas</option>
                  <option value="colores">Colores</option>
              </select>
          </div>

        </div>
      </div>

      <div class="table-scroll" id="tableScroll">

          <table class="data-table">
              <thead>
                  <tr>
                  <th>Palabra</th>
                  <th>Acciones</th>
                  </tr>
              </thead>
              <tbody id="tbody-palabras">
                  {% include "almacenista/_tbody_fragment.html" %}
              </tbody>
          </table>

      </div>


    </div>
  </div>

  <!-- Modal de configuraciones de productos -->
  <div id="modalConfiguraciones" class="modal-gestion-producto">
      <div class="modal-content-gestion-producto">

        <span class="close">&times;</span>
        <h2>‚öôÔ∏è Configuraciones de Producto</h2>
        <p>Puedes agregar nuevos tipos, tallas o colores de producto.</p>

        <div class="form-section">
          {% csrf_token %}             
          <div class="row">
            <input id="nuevoTipo" type="text" placeholder="Nuevo tipo">
            <button class="btn-add" onclick="agregarTipo()">Agregar Tipo</button>
          </div>

          <div class="row">
            <input id="nuevaTalla" type="text" placeholder="Nueva talla">
            <button class="btn-add" onclick="agregarTalla()">Agregar Talla</button>
          </div>
              
          <div class="row">
            <input id="nuevoColor" type="text" placeholder="Nuevo color">
            <button class="btn-add" onclick="agregarColor()">Agregar Color</button>
          </div>
        </div>

      </div>
  </div>




  <!-- Modal Configuraciones Adicionales -->
  <div id="modalConfiguracionesAdicionales" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>‚öôÔ∏è Configuraciones Adicionales</h2>
      <p>Puedes agregar nuevos centros o programas de formaci√≥n.</p>

      <!-- FORMULARIO: agregar centro -->
      <form method="POST" action="{% url 'agregar_centro' %}">
        {% csrf_token %}
        <div class="form-row">
          <input name="nombre" type="text" placeholder="Nuevo centro de formaci√≥n" required>
          <button type="submit" class="btn-add">Agregar Centro</button>
        </div>
      </form>

      <hr>

      <!-- FORMULARIO: agregar programa -->
      <form method="POST" action="{% url 'agregar_programa' %}">
        {% csrf_token %}
        <div class="form-row">
          <select name="centro_id" required>
            {% for c in centros %}
              <option value="{{ c.id_centro }}">{{ c.nombre }}</option>
            {% endfor %}
          </select>
          <input name="nombre" type="text" placeholder="Nuevo programa de formaci√≥n" required>
          <button type="submit" class="btn-add">Agregar Programa</button>
        </div>
      </form>
    </div>
  </div>

{% endblock %}

{% block scripts %}

  <!-- Script de Filtros de Busqueda y Eliminar -->
  <script>
      let tablaActual = '';
      let datosOriginales = [];

      // Carga inicial
      document.getElementById('selTabla').addEventListener('change', async function () {
          tablaActual = this.value;
          if (!tablaActual) return;

          const resp = await fetch(`{% url 'listado_tablas' %}?tabla=${tablaActual}&fmt=html`);
          const html = await resp.text();
          document.getElementById('tbody-palabras').innerHTML = html;

          // Guardar datos en memoria
          const rows = document.querySelectorAll('#tbody-palabras tr[data-id]');
          datosOriginales = Array.from(rows).map(tr => ({
              pk: tr.dataset.id,
              nombre: tr.cells[1].textContent.trim()
          }));
      });

      // Filtro en tiempo real
      document.getElementById('txt_palabra').addEventListener('input', () => {
          const q = document.getElementById('txt_palabra').value.trim().toLowerCase();
          const tbody = document.getElementById('tbody-palabras');

          let html = '';
          datosOriginales
              .filter(item => item.nombre.toLowerCase().includes(q))
              .forEach(item => {
                  html += `
                  <tr data-id="${item.pk}">
                      <td>${item.pk}</td>
                      <td>${item.nombre}</td>
                      <td>
                          <button class="eliminar-btn js-eliminar" data-id="${item.pk}">Eliminar</button>
                      </td>
                  </tr>`;
              });

          tbody.innerHTML = html || '<tr><td colspan="3" style="text-align:center; color:gray;">Sin coincidencias</td></tr>';
      });

    // Eliminar directo (sin confirmaci√≥n)
    document.getElementById('tbody-palabras').addEventListener('click', async e => {
        if (!e.target.classList.contains('js-eliminar')) return;
        const pk = e.target.dataset.id;
        if (!tablaActual) return;

        try {
            const res = await fetch(`{% url 'eliminar_palabra' %}?tabla=${tablaActual}&id=${pk}`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });

            const data = await res.json();

            if (res.ok && data.ok) {
                // Recargar tabla
                document.getElementById('selTabla').dispatchEvent(new Event('change'));
                document.getElementById('txt_palabra').value = '';

                // Mostrar mensaje de √©xito con tu funci√≥n existente
                showNotification("Palabra eliminada correctamente", "success");
            } else {
                console.error(data.error || 'Error al eliminar');
                showNotification("Error al eliminar la palabra", "error");
            }
        } catch (err) {
            console.error('Error al eliminar:', err);
            showNotification("Ocurri√≥ un error inesperado", "error");
        }
    });
  </script>

  <!-- script de configuraciones de productos -->
  <script>
    // üß© Mostrar / ocultar modal
    const modalConfig = document.getElementById("modalConfiguraciones");
    const btnAbrirConfig = document.getElementById("btnAbrirConfiguraciones");
    const btnCerrarConfig = modalConfig.querySelector(".close");

    btnAbrirConfig.onclick = () => modalConfig.style.display = "block";
    btnCerrarConfig.onclick = () => modalConfig.style.display = "none";
    window.onclick = (e) => { if (e.target === modalConfig) modalConfig.style.display = "none"; };

    // üü¢ Agregar Tipo
    function agregarTipo() {
      const tipo = document.getElementById('nuevoTipo').value.trim();
      if (!tipo) return showNotification("Ingresa un tipo", "warning");
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'agregar_tipo' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ nombre: tipo }),
        credentials: "same-origin"
      })
      .then(res => res.json())
      .then(data => {
        showNotification(data.message, data.success ? "success" : "warning");
        if (data.success) document.getElementById('nuevoTipo').value = "";
      })
      .catch(() => showNotification("Error al enviar los datos", "error"));
    }

    // üü¢ Agregar Talla
    function agregarTalla() {
      const talla = document.getElementById('nuevaTalla').value.trim();
      if (!talla) return showNotification("Ingresa una talla", "warning");
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'agregar_talla' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ nombre: talla }),
        credentials: "same-origin"
      })
      .then(res => res.json())
      .then(data => {
        showNotification(data.message, data.success ? "success" : "warning");
        if (data.success) document.getElementById('nuevaTalla').value = "";
      })
      .catch(() => showNotification("Error al enviar los datos", "error"));
    }

    // üü¢ Agregar Color
    function agregarColor() {
      const color = document.getElementById('nuevoColor').value.trim();
      if (!color) return showNotification("Ingresa un color", "warning");
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'agregar_color' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ nombre: color }),
        credentials: "same-origin"
      })
      .then(res => res.json())
      .then(data => {
        showNotification(data.message, data.success ? "success" : "warning");
        if (data.success) document.getElementById('nuevoColor').value = "";
      })
      .catch(() => showNotification("Error al enviar los datos", "error"));
    }
  </script>

  <!-- Script para configuraciones adicionales -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const modal = document.getElementById("modalConfiguracionesAdicionales");
      const btnAbrir = document.getElementById("btnAbrirConfiguracionesAdicionales");
      const btnCerrar = modal.querySelector(".close");
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      // Abrir modal
      btnAbrir.addEventListener("click", () => modal.style.display = "block");

      // Cerrar modal
      btnCerrar.addEventListener("click", () => modal.style.display = "none");
      window.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });

      // Agregar Centro
      document.getElementById("btnAgregarCentro").addEventListener("click", () => {
        const nombre = document.getElementById("nuevoCentro").value.trim();
        if (!nombre) return showNotification("Ingresa un nombre de centro", "warning");

        fetch("{% url 'agregar_centro' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
          },
          body: new URLSearchParams({ nombre })
        })
        .then(res => res.json())
        .then(data => {
          if (!data.success) throw new Error(data.error || "Error desconocido");
          showNotification("Centro agregado correctamente", "success");

          document.getElementById("nuevoCentro").value = "";

          const select = document.getElementById("centroSelect");
          const option = document.createElement("option");
          option.value = data.id_centro;
          option.textContent = data.nombre;
          select.appendChild(option);
          option.selected = true;
        })
        .catch(err => showNotification("Error: " + err.message, "error"));
      });

      // Agregar Programa
      document.getElementById("btnAgregarPrograma").addEventListener("click", () => {
        const nombre = document.getElementById("nuevoPrograma").value.trim();
        const centroId = document.getElementById("centroSelect").value;
        if (!nombre) return showNotification("Ingresa un nombre de programa", "warning");
        if (!centroId) return showNotification("Selecciona un centro", "warning");

        fetch("{% url 'agregar_programa' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
          },
          body: new URLSearchParams({ nombre, centro_id: centroId })
        })
        .then(res => res.json())
        .then(data => {
          if (!data.success) throw new Error(data.error || "Error desconocido");
          showNotification("Programa agregado correctamente", "success");

          document.getElementById("nuevoPrograma").value = "";

          const programaSelect = document.getElementById("programaSelect");
          if (programaSelect) {
            const option = document.createElement("option");
            option.value = data.id_programa;
            option.textContent = data.nombre;
            programaSelect.appendChild(option);
            option.selected = true;
          }
        })
        .catch(err => showNotification("Error: " + err.message, "error"));
      });
    });
  </script>

{% endblock %}