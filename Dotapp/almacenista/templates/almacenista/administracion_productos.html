{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="admin-container">
    <div class="admin-card">
      <div class="sticky-sync-wrapper">
        <!-- Flecha atr√°s -->
        <button type="button" class="btn-back-big" onclick="history.back()" aria-label="Volver">
          ‚Üê
        </button>
        
        <div class="slide" id="slideSync">

          <img src="{% static 'img/logo-dotapp-sena.png' %}" alt="Logo DotApp SENA" class="logo" />
          <h1>Gesti√≥n de Productos</h1>

          <div class="form-group">
            <!-- Buscador de Productos -->
            <input type="text" id="buscador" placeholder="Buscar producto...">
          </div>

          <div class="btn-producto-group">
            <!-- Bot√≥n que activa modal de agregar producto -->
            <button id="btnAbrirAgregar" class="btn-agregar">Agregar Producto</button>

            <!-- Bot√≥n para abrir el modal de configuracion de productos -->
            <button id="btnAbrirConfiguraciones" class="btn-config">
              ‚öôÔ∏è Configuraciones de Producto
            </button>
          </div>
        </div>
      </div>

      <div class="table-scroll" id="tableScroll">

        <table class="data-table">
          <thead>
            <tr>
              <th>ID_Producto</th>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Talla</th>
              <th>Color</th>
              <th>Stock</th>
              <th>Precio</th>
              <th>Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for producto in productos %}
            <tr>
              <td>{{ producto.id_producto }}</td>
              <td>
                {% if producto.imagen %}
                  <img src="{{ MEDIA_URL }}{{ producto.imagen }}" alt="Imagen del producto" width="100">
                {% else %}
                  Sin imagen
                {% endif %}
              </td>
              <td>{{ producto.tipo.nombre }}</td>
              <td>{{ producto.talla.nombre }}</td>
              <td>{{ producto.color.nombre }}</td>
              <td>{{ producto.stock }}</td>
              <td>{{ producto.precio }}</td>
              <td>
                <button class="btn btn-editar js-editar" data-id="{{ producto.id_producto }}" data-action="editar">Editar</button>
                <button class="btn btn-eliminar js-eliminar" data-id="{{ producto.id_producto }}" data-action="eliminar">Eliminar</button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8">No hay productos registrados.</td>
            </tr>
            {% endfor %}
          </tbody>

        </table>

      </div>

    </div>
  </div>

  <!-- Modal de Editar -->
  <div id="modalAccion" class="modal-gestion-producto">
    <div class="modal-content-gestion-producto">
      <span class="close">&times;</span>
      <h2 id="modalTitulo"></h2>
      <div id="modalBody"></div>

      <div class="modal-footer">
        <button id="btnConfirmar" type="button" class="btn btn-guardar">Confirmar</button>
        <button id="btnCancelar" type="button" class="btn btn-cancelar">Cancelar</button>
      </div>
    </div>
  </div>


  <!-- Modal de Eliminar producto -->
  <div id="modalEliminar" class="modal-gestion-producto">
    <div class="modal-content-gestion-producto">
      <span class="close" id="cerrarEliminar">&times;</span>

      <h2>Eliminar producto</h2>
      <div id="modalEliminarBody">
        <p>¬øEst√°s seguro de que deseas eliminar este producto?</p>
      </div>

      <div class="modal-footer">
        <button id="btnEliminarConfirmar" type="button" class="btn btn-eliminar-productos">Eliminar</button>
        <button id="btnEliminarCancelar" type="button" class="btn btn-cancelar">Cancelar</button>
      </div>
    </div>
  </div>


  <!-- Modal Agregar Producto -->
  <div id="modalAgregar" class="modal-gestion-producto">
    <div class="modal-content-gestion-producto">
      <span class="close">&times;</span>
      <h2>Agregar Producto</h2>
      <form id="formAgregar" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <label for="inputTipo">Tipo:</label>
        <select name="tipo" id="inputTipo" required>
          <option value="">Seleccione un tipo</option>
          {% for tipo in tipos %}
            <option value="{{ tipo.id_tipo }}">{{ tipo.nombre }}</option>
          {% endfor %}
        </select>

        <label for="inputTalla">Talla:</label>
        <select name="talla" id="inputTalla" required>
          <option value="">Seleccione una talla</option>
          {% for talla in tallas %}
            <option value="{{ talla.id_talla }}">{{ talla.nombre }}</option>
          {% endfor %}
        </select>

        <label for="inputColor">Color:</label>
        <select name="color" id="inputColor" required>
          <option value="">Seleccione un color</option>
          {% for color in colores %}
            <option value="{{ color.id_color }}">{{ color.nombre }}</option>
          {% endfor %}
        </select>

        <label for="inputPrecio">Precio:</label>
        <input type="number" name="precio" id="inputPrecio" placeholder="Precio" min="0" step="0.01" required />

        <label for="inputCantidad">Cantidad disponible:</label>
        <input type="number" name="cantidad" id="inputCantidad" placeholder="Cantidad disponible" min="1" required />

        <label for="inputImagen">Imagen en formato PNG o JPEG:</label>
        <input type="file" id="inputImagen" name="imagen" accept="image/png, image/jpeg" required />

        <div class="modal-footer">
          <button type="submit" class="btn btn-guardar">Agregar</button>
          <button type="button" class="btn btn-cancelar">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de configuraciones de productos -->
  <div id="modalConfiguraciones" class="modal-gestion-producto">
    <div class="modal-content-gestion-producto">
      <span class="close">&times;</span>
      <h2>‚öôÔ∏è Configuraciones de Producto</h2>
      <p>Puedes agregar nuevos tipos, tallas o colores de producto.</p>

      <div class="form-section">
        <div class="row">
          <input id="nuevoTipo" type="text" placeholder="Nuevo tipo">
          <button class="btn-add" onclick="agregarTipo()">Agregar Tipo</button>
        </div>
        <div class="row">
          <input id="nuevaTalla" type="text" placeholder="Nueva talla">
          <button class="btn-add" onclick="agregarTalla()">Agregar Talla</button>
        </div>
        <div class="row">
          <input id="nuevoColor" type="text" placeholder="Nuevo color">
          <button class="btn-add" onclick="agregarColor()">Agregar Color</button>
        </div>
      </div>
    </div>
  </div>
  
{% endblock %}

{% block scripts %}

  <!-- script de configuraciones de productos -->
  <script>
    // üß© Mostrar / ocultar modal
    const modalConfig = document.getElementById("modalConfiguraciones");
    const btnAbrirConfig = document.getElementById("btnAbrirConfiguraciones");
    const btnCerrarConfig = modalConfig.querySelector(".close");

    btnAbrirConfig.onclick = () => modalConfig.style.display = "block";
    btnCerrarConfig.onclick = () => modalConfig.style.display = "none";
    window.onclick = (e) => { if (e.target === modalConfig) modalConfig.style.display = "none"; };

    // üü¢ Agregar Tipo
    function agregarTipo() {
      const tipo = document.getElementById('nuevoTipo').value.trim();
      if (!tipo) return alert("‚ö†Ô∏è Ingresa un tipo");
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'agregar_tipo' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ nombre: tipo }),
        credentials: "same-origin"
      })
      .then(res => {
        if (!res.ok) throw new Error();
        alert("‚úÖ Tipo agregado correctamente");
        document.getElementById('nuevoTipo').value = "";
      })
      .catch(() => alert("‚ö†Ô∏è Error al enviar los datos"));
    }

    // üü£ Agregar Talla
    function agregarTalla() {
      const talla = document.getElementById('nuevaTalla').value.trim();
      if (!talla) return alert("‚ö†Ô∏è Ingresa una talla");
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'agregar_talla' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ nombre: talla }),
        credentials: "same-origin"
      })
      .then(res => {
        if (!res.ok) throw new Error();
        alert("‚úÖ Talla agregada correctamente");
        document.getElementById('nuevaTalla').value = "";
      })
      .catch(() => alert("‚ö†Ô∏è Error al enviar los datos"));
    }

    // üîµ Agregar Color
    function agregarColor() {
      const color = document.getElementById('nuevoColor').value.trim();
      if (!color) return alert("‚ö†Ô∏è Ingresa un color");
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch("{% url 'agregar_color' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({ nombre: color }),
        credentials: "same-origin"
      })
      .then(res => {
        if (!res.ok) throw new Error();
        alert("‚úÖ Color agregado correctamente");
        document.getElementById('nuevoColor').value = "";
      })
      .catch(() => alert("‚ö†Ô∏è Error al enviar los datos"));
    }
  </script>


  <!-- script de agregar producto -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Datos de Django pasados como JSON
      const tipos = JSON.parse(document.getElementById('tipos-data').textContent);
      const tallas = JSON.parse(document.getElementById('tallas-data').textContent);
      const colores = JSON.parse(document.getElementById('colores-data').textContent);

      // --- MODAL AGREGAR ---
      const modalAgregar = document.getElementById("modalAgregar");
      const btnAbrirAgregar = document.getElementById("btnAbrirAgregar");
      const btnCerrarAgregar = modalAgregar.querySelector(".close");
      const btnCancelarAgregar = modalAgregar.querySelector(".btn-cancelar");
      const formAgregar = document.getElementById("formAgregar");

      btnAbrirAgregar.onclick = () => modalAgregar.style.display = "block";
      btnCerrarAgregar.onclick = () => modalAgregar.style.display = "none";
      btnCancelarAgregar.onclick = () => modalAgregar.style.display = "none";

      formAgregar.onsubmit = e => {
        e.preventDefault();
        const formData = new FormData(formAgregar);
        fetch("/almacenista/agregar-producto/", {
          method: "POST",
          headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: formData
        }).then(res => res.json())
          .then(data => {
            if (data.status === 'ok') {
              alert("Producto agregado correctamente");
              location.reload();
            } else {
              alert("Error al agregar producto");
            }
          });
      };

      // --- MODAL EDITAR ---
      const modalEditar = document.getElementById("modalAccion");
      const modalTitulo = document.getElementById("modalTitulo");
      const modalBody = document.getElementById("modalBody");
      const btnConfirmar = document.getElementById("btnConfirmar");
      const btnCancelar = document.getElementById("btnCancelar");
      const btnCerrar = modalEditar.querySelector(".close");

      let productoId = null;

      document.querySelectorAll(".js-editar").forEach(btn => {
        btn.addEventListener("click", () => {
          productoId = btn.dataset.id;
          modalTitulo.textContent = "Editar producto";

          // Construir formulario con selects
          modalBody.innerHTML = `
            <form id="formEditar" enctype="multipart/form-data">
              <label for="editarTipo">Tipo:</label>
              <select name="tipo" id="editarTipo" required>
                <option value="">Seleccione un tipo</option>
              </select>

              <label for="editarTalla">Talla:</label>
              <select name="talla" id="editarTalla" required>
                <option value="">Seleccione una talla</option>
              </select>

              <label for="editarColor">Color:</label>
              <select name="color" id="editarColor" required>
                <option value="">Seleccione un color</option>
              </select>

              <label for="editarCantidad">Cantidad:</label>
              <input type="number" name="cantidad" id="editarCantidad" min="0" required>

              <label for="editarPrecio">Precio:</label>
              <input type="number" name="precio" id="editarPrecio" min="0" step="0.01" required>

              <label for="editarImagen">Imagen:</label>
              <input type="file" name="imagen" id="editarImagen">
            </form>
          `;

          const selectTipo = document.getElementById("editarTipo");
          const selectTalla = document.getElementById("editarTalla");
          const selectColor = document.getElementById("editarColor");

          tipos.forEach(t => selectTipo.appendChild(new Option(t.nombre, t.id_tipo)));
          tallas.forEach(t => selectTalla.appendChild(new Option(t.nombre, t.id_talla)));
          colores.forEach(c => selectColor.appendChild(new Option(c.nombre, c.id_color)));

          // Precargar valores desde la fila
          const fila = btn.closest("tr");
          selectTipo.value = fila.dataset.tipoId;
          selectTalla.value = fila.dataset.tallaId;
          selectColor.value = fila.dataset.colorId;
          document.getElementById("editarCantidad").value = parseInt(fila.children[5].textContent.trim());
          document.getElementById("editarPrecio").value = parseFloat(fila.children[6].textContent.trim());

          modalEditar.style.display = "block";
        });
      });

      btnCancelar.onclick = () => modalEditar.style.display = "none";
      btnCerrar.onclick = () => modalEditar.style.display = "none";

      btnConfirmar.onclick = () => {
        const formData = new FormData(document.getElementById("formEditar"));
        fetch(`/almacenista/productos/editar/${productoId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: formData
        }).then(res => {
          if (res.ok) location.reload();
          else alert("Error al editar el producto.");
        });
        modalEditar.style.display = "none";
      };
    });
  </script>

  <!-- script de editar producto -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("modalAgregar");
        const btnAbrir = document.getElementById("btnAbrirAgregar");
        const btnCerrar = modal.querySelector(".close");
        const btnCancelar = modal.querySelector(".btn-cancelar");

        btnAbrir.onclick = () => modal.style.display = "block";
        btnCerrar.onclick = () => modal.style.display = "none";
        btnCancelar.onclick = () => modal.style.display = "none";

        // Cerrar modal al hacer clic fuera del contenido
        window.onclick = (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        };
    });
  </script>


  <!-- script de eliminar producto -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modalEliminar = document.getElementById("modalEliminar");
      const btnEliminarConfirmar = document.getElementById("btnEliminarConfirmar");
      const btnEliminarCancelar = document.getElementById("btnEliminarCancelar");
      const btnCerrarEliminar = document.getElementById("cerrarEliminar");

      let productoId = null;

      // Abrir modal de eliminar cuando se presiona el bot√≥n en la tabla
      document.querySelectorAll(".js-eliminar").forEach(btn => {
        btn.addEventListener("click", () => {
          productoId = btn.dataset.id;
          document.getElementById("modalEliminarBody").innerHTML = `
            <p>¬øEst√°s seguro de que deseas eliminar el producto con ID <b>${productoId}</b>?</p>
          `;
          modalEliminar.style.display = "block";
        });
      });

      // Cerrar modal
      btnEliminarCancelar.onclick = () => modalEliminar.style.display = "none";
      btnCerrarEliminar.onclick = () => modalEliminar.style.display = "none";

      // Confirmar eliminaci√≥n
      btnEliminarConfirmar.onclick = () => {
        fetch(`/almacenista/productos/eliminar/${productoId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": "TibWfsgf4cwatC2yFGdKj8Z0rIXHbeM2Lnd4d4GvqfzAEGTyLi49rK0Hm3bizcS4" }
        }).then(res => {
          if (res.ok) {
            alert("Producto eliminado correctamente");
            location.reload();
          } else {
            alert("Error al eliminar el producto");
          }
        });
        modalEliminar.style.display = "none";
      };
    });
  </script>

  <!-- Script de Validacion de formato de imagen y dimensiones -->
  <script>
    const inputImagen = document.getElementById("inputImagen");

    inputImagen.addEventListener("change", function () {
      const archivo = this.files[0];
      if (!archivo) return;

      // Validar tipo de archivo
      if (archivo.type !== "image/png" && archivo.type !== "image/jpeg") {
        alert("‚ùå Solo se permiten im√°genes PNG o JPEG.");
        inputImagen.value = "";
        return;
      }

      // Validar dimensiones
      const img = new Image();
      img.src = URL.createObjectURL(archivo);

      img.onload = function () {
        const ancho = img.width;
        const alto = img.height;

        if (ancho > 225 || alto > 225) {
          alert(`‚ùå La imagen debe ser m√°ximo de 225x225 px. Subiste ${ancho}x${alto}px`);
          inputImagen.value = ""; // limpiar el input
        } else {
          alert("‚úÖ Imagen v√°lida");
        }
      };
    });
  </script>

  <!-- Script para el buscador de productos -->
  <script>
    const buscador = document.getElementById("buscador");
    const tabla = document.querySelector(".data-table tbody");

    // Crear fila de mensaje
    let filaNoEncontrado = document.createElement("tr");
    let celdaMensaje = document.createElement("td");
    celdaMensaje.colSpan = tabla.parentNode.querySelectorAll("thead th").length; 
    celdaMensaje.textContent = "Producto no encontrado";
    celdaMensaje.style.textAlign = "center";
    celdaMensaje.style.fontWeight = "bold";
    celdaMensaje.style.color = "#555";
    filaNoEncontrado.appendChild(celdaMensaje);
    filaNoEncontrado.style.display = "none";
    tabla.appendChild(filaNoEncontrado);

    buscador.addEventListener("keyup", function () {
      const filtro = buscador.value.toLowerCase();
      const filas = tabla.querySelectorAll("tr:not(:last-child)"); // Ignorar la fila de mensaje
      let coincidencias = 0;

      filas.forEach(fila => {
        const celdas = fila.getElementsByTagName("td");
        let coincide = false;

        for (let j = 0; j < celdas.length - 1; j++) { // -1 para no buscar en botones
          if (celdas[j].textContent.toLowerCase().includes(filtro)) {
            coincide = true;
            break;
          }
        }

        fila.style.display = coincide ? "" : "none";
        if (coincide) coincidencias++;
      });

      // Mostrar/ocultar mensaje dentro de la tabla
      filaNoEncontrado.style.display = coincidencias === 0 ? "" : "none";
    });
  </script>

  <!-- Script para sincronizar el slider con la tabla -->
  <script>
    const tableScroll = document.getElementById('tableScroll');
    const slideSync   = document.getElementById('slideSync');

    function syncCenter() {
      const scrollLeft = tableScroll.scrollLeft;
      const viewportW  = tableScroll.clientWidth;
      const slideW     = slideSync.offsetWidth;

      const factor = 0;
      const offset = scrollLeft * factor + (viewportW - slideW) / 2 * factor;

      slideSync.style.transform = `translateX(${offset}px)`;
    }

    tableScroll.addEventListener('scroll', syncCenter);
    window.addEventListener('resize', syncCenter);
    syncCenter(); // inicial
  </script>

{% endblock %}

