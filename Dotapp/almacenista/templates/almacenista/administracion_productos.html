{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="admin-container">
    <div class="admin-card">
      <div class="sticky-sync-wrapper">
        <!-- Flecha atrás -->
        <button type="button" class="btn-back-big" onclick="window.location.href='{% url 'dashboard-almacenista' %}'" aria-label="Volver">
          ←
        </button>
        
        <div class="slide" id="slideSync">

          <img src="{% static 'img/logo-dotapp-sena.png' %}" alt="Logo DotApp SENA" class="logo" />
          <h1>Gestión de Productos</h1>

          <div class="form-group">
            <!-- Buscador de Productos -->
            <input type="text" id="buscador" placeholder="Buscar producto...">
          </div>

          <div class="btn-producto-group">
            <!-- Botón que activa modal de agregar producto -->
            <button id="btnAbrirAgregar" class="btn-agregar">Agregar Producto</button>

            <!-- Botón para abrir el modal de configuracion de productos -->
            <button onclick="window.location.href='{% url 'gestion_palabras' %}'" class="btn-config">
              ⚙️ Configuraciones Adicionales
            </button>
          </div>
        </div>
      </div>

      <div class="table-scroll" id="tableScroll">

        <table class="data-table">
          <thead>
            <tr>
              <th>ID_Producto</th>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Talla</th>
              <th>Color</th>
              <th>Stock</th>
              <th>Precio</th>
              <th>Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for producto in productos %}
            <tr>
              <td>{{ producto.id_producto }}</td>
              <td>
                {% if producto.imagen %}
                  <img src="{{ MEDIA_URL }}{{ producto.imagen }}" alt="Imagen del producto" width="100">
                {% else %}
                  Sin imagen
                {% endif %}
              </td>
              <td>{{ producto.tipo.nombre }}</td>
              <td>{{ producto.talla.nombre }}</td>
              <td>{{ producto.color.nombre }}</td>
              <td>{{ producto.stock }}</td>
              <td>{{ producto.precio }}</td>
              <td>
                <button class="btn btn-editar js-editar" data-id="{{ producto.id_producto }}" data-action="editar">Editar</button>
                <button class="btn btn-eliminar js-eliminar" data-id="{{ producto.id_producto }}" data-action="eliminar">Eliminar</button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8">No hay productos registrados.</td>
            </tr>
            {% endfor %}
          </tbody>

        </table>

      </div>

    </div>
  </div>

  <!-- Modal de Editar -->
  <div id="modalAccion" class="modal-gestion-producto">
    <div class="modal-content-gestion-producto">
      <span class="close">&times;</span>
      <h2 id="modalTitulo"></h2>
      <div id="modalBody"></div>

      <div class="modal-footer">
        <button id="btnConfirmar" type="button" class="btn btn-guardar">Confirmar</button>
        <button id="btnCancelar" type="button" class="btn btn-cancelar">Cancelar</button>
      </div>
    </div>
  </div>


  <!-- Modal de Eliminar producto -->
  <div id="modalEliminar" class="modal-gestion-producto">
    <div class="modal-content-gestion-producto">
      <span class="close" id="cerrarEliminar">&times;</span>

      <h2>Eliminar producto</h2>
      <div id="modalEliminarBody">
        <p>¿Estás seguro de que deseas eliminar este producto?</p>
      </div>

      <div class="modal-footer">
        <button id="btnEliminarConfirmar" type="button" class="btn btn-eliminar-productos">Eliminar</button>
        <button id="btnEliminarCancelar" type="button" class="btn btn-cancelar">Cancelar</button>
      </div>
    </div>
  </div>


  <!-- Modal Agregar Producto -->
  <div id="modalAgregar" class="modal-gestion-producto">
    <div class="modal-content-gestion-producto">
      <span class="close">&times;</span>
      <h2>Agregar Producto</h2>
      <form id="formAgregar" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <label for="inputTipo">Tipo:</label>
        <select name="tipo" id="inputTipo" required>
          <option value="">Seleccione un tipo</option>
          {% for tipo in tipos %}
            <option value="{{ tipo.nombre }}">{{ tipo.nombre }}</option>
          {% endfor %}
        </select>

        <label for="inputTalla">Talla:</label>
        <select name="talla" id="inputTalla" required>
          <option value="">Seleccione una talla</option>
          {% for talla in tallas %}
            <option value="{{ talla.nombre }}">{{ talla.nombre }}</option>
          {% endfor %}
        </select>

        <label for="inputColor">Color:</label>
        <select name="color" id="inputColor" required>
          <option value="">Seleccione un color</option>
          {% for color in colores %}
            <option value="{{ color.nombre }}">{{ color.nombre }}</option>
          {% endfor %}
        </select>

        <label for="inputPrecio">Precio:</label>
        <input type="number" name="precio" id="inputPrecio" placeholder="Precio" min="0" step="0.01" required />

        <label for="inputCantidad">Cantidad disponible:</label>
        <input type="number" name="cantidad" id="inputCantidad" placeholder="Cantidad disponible" min="1" required />

        <label for="inputImagen">Imagen en formato PNG o JPEG:</label>
        <input type="file" id="inputImagen" name="imagen" accept="image/png, image/jpeg" required />

        <div class="modal-footer">
          <button type="submit" class="btn btn-guardar">Agregar</button>
          <button type="button" class="btn btn-cancelar">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
  
{% endblock %}

{% block scripts %}

  <!-- ✅ Datos pasados desde Django como JSON -->
  <script id="tipos-data" type="application/json">{{ tipos_json|safe }}</script>
  <script id="tallas-data" type="application/json">{{ tallas_json|safe }}</script>
  <script id="colores-data" type="application/json">{{ colores_json|safe }}</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ✅ Cargar datos desde Django
    const tipos = JSON.parse(document.getElementById('tipos-data').textContent);
    const tallas = JSON.parse(document.getElementById('tallas-data').textContent);
    const colores = JSON.parse(document.getElementById('colores-data').textContent);

    // ✅ --- MODAL AGREGAR ---
    const modalAgregar = document.getElementById("modalAgregar");
    const btnAbrirAgregar = document.getElementById("btnAbrirAgregar");
    const btnCerrarAgregar = modalAgregar.querySelector(".close");
    const btnCancelarAgregar = modalAgregar.querySelector(".btn-cancelar");
    const formAgregar = document.getElementById("formAgregar");

    btnAbrirAgregar.onclick = () => modalAgregar.style.display = "block";
    btnCerrarAgregar.onclick = () => modalAgregar.style.display = "none";
    btnCancelarAgregar.onclick = () => modalAgregar.style.display = "none";

    formAgregar.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(formAgregar);

      try {
        const res = await fetch("/almacenista/agregar-producto/", {
          method: "POST",
          headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: formData
        });

        const data = await res.json();
        if (data.status === 'ok') {
          showNotification("✅ Producto agregado correctamente", "success");
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          showNotification(data.message || "❌ Error al agregar el producto", "error");
        }
      } catch (err) {
        console.error("Error al agregar producto:", err);
        showNotification("❌ Error al conectar con el servidor", "error");
      }
    };

    // --- MODAL EDITAR ---
    const modalEditar = document.getElementById("modalAccion");
    const modalTitulo = document.getElementById("modalTitulo");
    const modalBody = document.getElementById("modalBody");
    const btnConfirmar = document.getElementById("btnConfirmar");
    const btnCancelar = document.getElementById("btnCancelar");
    const btnCerrar = modalEditar.querySelector(".close");

    let productoId = null;

    document.querySelectorAll(".js-editar").forEach(btn => {
      btn.addEventListener("click", () => {
        productoId = btn.dataset.id;
        modalTitulo.textContent = "Editar producto";

        const fila = btn.closest("tr");
        const tipoActual = fila.children[2].textContent.trim();
        const tallaActual = fila.children[3].textContent.trim();
        const colorActual = fila.children[4].textContent.trim();
        const stockActual = fila.children[5].textContent.trim();
        const precioActual = fila.children[6].textContent.trim();
        const precioLimpio = parseFloat(precioActual.replace(/\./g, '').replace(',', '.')) || 0;

        modalBody.innerHTML = `
          <form id="formEditar" enctype="multipart/form-data">
            <label>Tipo:</label>
            <select name="tipo" id="editarTipo" required></select>

            <label>Talla:</label>
            <select name="talla" id="editarTalla" required></select>

            <label>Color:</label>
            <select name="color" id="editarColor" required></select>

            <label>Cantidad:</label>
            <input type="number" name="cantidad" value="${stockActual}" min="0" required>

            <label>Precio:</label>
            <input type="number" name="precio" value="${precioLimpio}" min="0" step="0.01" required>

            <label>Imagen (opcional):</label>
            <input type="file" name="imagen" accept="image/png, image/jpeg">
          </form>
        `;

        // Llenar selects
        const fillSelect = (id, items, selected) => {
          const sel = document.getElementById(id);
          items.forEach(i => {
            const opt = new Option(i.nombre, i.nombre);
            if (i.nombre === selected) opt.selected = true;
            sel.add(opt);
          });
        };
        fillSelect("editarTipo", tipos, tipoActual);
        fillSelect("editarTalla", tallas, tallaActual);
        fillSelect("editarColor", colores, colorActual);

        modalEditar.style.display = "block";
      });
    });

    btnCancelar.onclick = () => modalEditar.style.display = "none";
    btnCerrar.onclick = () => modalEditar.style.display = "none";

    btnConfirmar.onclick = async () => {
      const formData = new FormData(document.getElementById("formEditar"));
      try {
        const res = await fetch(`/almacenista/productos/editar/${productoId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value },
          body: formData
        });

        const data = await res.json();
        if (data.status === "ok") {
          showNotification(data.message || "Producto editado correctamente", "success");
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          showNotification(data.message || "Error al editar producto", "error");
        }
      } catch (error) {
        console.error("Error al editar producto:", error);
        showNotification("Error al conectar con el servidor", "error");
      }
      modalEditar.style.display = "none";
    };

    // ✅ --- MODAL ELIMINAR ---
    const modalEliminar = document.getElementById("modalEliminar");
    const btnEliminarConfirmar = document.getElementById("btnEliminarConfirmar");
    const btnEliminarCancelar = document.getElementById("btnEliminarCancelar");
    const btnCerrarEliminar = document.getElementById("cerrarEliminar");

    let idEliminar = null;

    document.querySelectorAll(".js-eliminar").forEach(btn => {
      btn.addEventListener("click", () => {
        idEliminar = btn.dataset.id;
        document.getElementById("modalEliminarBody").innerHTML = `
          <p>¿Estás seguro de eliminar el producto con ID <b>${idEliminar}</b>?</p>
        `;
        modalEliminar.style.display = "block";
      });
    });

    btnEliminarCancelar.onclick = () => modalEliminar.style.display = "none";
    btnCerrarEliminar.onclick = () => modalEliminar.style.display = "none";

    btnEliminarConfirmar.onclick = async () => {
      try {
        const res = await fetch(`/almacenista/productos/eliminar/${idEliminar}/`, {
          method: "POST",
          headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
        });

        const data = await res.json();
        if (data.status === "ok") {
          showNotification(data.message || "✅ Producto eliminado correctamente", "success");
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          showNotification(data.message || "❌ Error al eliminar producto", "error");
        }
      } catch (error) {
        console.error("Error al eliminar producto:", error);
        showNotification("❌ Error al conectar con el servidor", "error");
      }
      modalEliminar.style.display = "none";
    };

    // ✅ --- VALIDACIÓN DE IMAGEN ---
    const validarImagen = (input) => {
      const archivo = input.files[0];
      if (!archivo) return;

      if (!["image/png", "image/jpeg"].includes(archivo.type)) {
        showNotification("Solo se permiten imágenes PNG o JPEG", "error");
        input.value = "";
        return;
      }

      const img = new Image();
      img.src = URL.createObjectURL(archivo);
      img.onload = () => {
        if (img.width > 1000 || img.height > 1000) {
          showNotification(`Máximo tamaño permitido: 1000x1000px. Tu imagen: ${img.width}x${img.height}`, "error");
          input.value = "";
        }
      };
    };

    document.getElementById("inputImagen")?.addEventListener("change", function () {
      validarImagen(this);
    });

    // ✅ --- BUSCADOR ---
    const buscador = document.getElementById("buscador");
    const tabla = document.querySelector(".data-table tbody");
    const filas = Array.from(tabla.querySelectorAll("tr"));

    buscador.addEventListener("keyup", () => {
      const filtro = buscador.value.toLowerCase();
      let coincidencias = 0;
      filas.forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        const coincide = texto.includes(filtro);
        fila.style.display = coincide ? "" : "none";
        if (coincide) coincidencias++;
      });

      let noEncontrado = document.getElementById("no-encontrado");
      if (!noEncontrado) {
        const tr = document.createElement("tr");
        tr.id = "no-encontrado";
        tr.innerHTML = `<td colspan="8" style="text-align:center;font-weight:bold;color:#555">Producto no encontrado</td>`;
        tabla.appendChild(tr);
        noEncontrado = tr;
      }
      noEncontrado.style.display = coincidencias === 0 ? "" : "none";
    });
  });
</script>


  <!-- Script para sincronizar el slider con la tabla -->
  <script>
    const tableScroll = document.getElementById('tableScroll');
    const slideSync   = document.getElementById('slideSync');

    function syncCenter() {
      const scrollLeft = tableScroll.scrollLeft;
      const viewportW  = tableScroll.clientWidth;
      const slideW     = slideSync.offsetWidth;

      const factor = 0;
      const offset = scrollLeft * factor + (viewportW - slideW) / 2 * factor;

      slideSync.style.transform = `translateX(${offset}px)`;
    }

    tableScroll.addEventListener('scroll', syncCenter);
    window.addEventListener('resize', syncCenter);
    syncCenter(); // inicial
  </script>

{% endblock %}

