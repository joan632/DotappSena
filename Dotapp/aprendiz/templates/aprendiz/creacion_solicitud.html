{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="perfil-container">
    <div class="perfil-card">
      <div class="sticky-sync-wrapper">
        <!-- Flecha atrás -->
        <button type="button" class="btn-back-small" onclick="history.back()" aria-label="Volver">
          ←
        </button>
        
        <div class="slide" id="slideSync">
          <img src="{% static 'img/logo-dotapp-sena.png' %}" alt="Logo DotApp SENA" class="logo" />
          <!-- Título -->
          <h1>Solicitud de Uniforme</h1>
          <br>
        </div>
      </div>

      <!-- Carrusel de productos -->
      <div class="carousel" aria-roledescription="carousel">

        <!-- Diapositivas dinámicas -->
        {% for producto in productos %}
        <figure class="slide">
          {% if producto.imagen %}
            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
          {% else %}
            <img src="{% static 'img/no-image.jpg' %}" alt="Sin imagen">
          {% endif %}
          
          <figcaption><h1>{{ producto.tipo }}</h1></figcaption>
          <figcaption>Color: {{ producto.color }}</figcaption>
          <figcaption>Stock disponible: {{ producto.stock }}</figcaption>
          <figcaption>Tallas disponibles: {{ producto.talla }}</figcaption>
          <figcaption>Precio unitario: {{ producto.precio }}</figcaption>
        </figure>
        {% empty %}
        <p>No hay productos disponibles.</p>
        {% endfor %}

        <!-- Controles del carrusel -->
        <div class="carousel-controls" aria-hidden="false">
          <button id="prev" aria-label="Anterior">❮</button>
          <button id="next" aria-label="Siguiente">❯</button>
        </div>
      </div>

      <br>
      
      <hr>
      <!-- Formulario de solicitud -->
      <form id="form-solicitud" action="{% url 'crear_solicitud' %}" method="POST">
        {% csrf_token %}

        <button type="submit" formaction="{% url 'guardar_borrador' %}" style="max-width: fit-content;" formnovalidate>Guardar borrador</button>
        <br><br>

        <!-- Tipo de uniforme -->
        <label for="tipo">Tipo de uniforme</label>
        <select name="tipo" id="tipo" required>
          <option value="">Selecciona un tipo de uniforme</option>
          {% for tipo in tipos %}
            <option value="{{ tipo.nombre }}" {% if borrador and borrador.tipo == tipo.nombre %}selected{% endif %}>
              {{ tipo.nombre }}
            </option>
          {% endfor %}
        </select>
        <br>

        <!-- Talla -->
        <label for="talla">Talla</label>
        <select name="talla" id="talla" required>
          <option value="">Selecciona una talla</option>
          {% for talla in tallas %}
            <option value="{{ talla.nombre }}" {% if borrador and borrador.talla == talla.nombre %}selected{% endif %}>
              {{ talla.nombre }}
            </option>
          {% endfor %}
        </select>
        <br>

        <!-- Color -->
        <label for="color">Color</label>
        <select name="color" id="color" required>
          <option value="">Selecciona un color</option>
          {% for color in colores %}
            <option value="{{ color.nombre }}" {% if borrador and borrador.color == color.nombre %}selected{% endif %}>
              {{ color.nombre }}
            </option>
          {% endfor %}
        </select>
        <br>


        <!-- Cantidad -->
        <label for="cantidad">Cantidad</label>
        <div class="form-group">
          <input type="number" id="cantidad" name="cantidad" step="1" min="1" required placeholder="" value="{{ borrador.cantidad|default:'' }}">
          <label for="cantidad">Digite la cantidad</label>
        </div>
        

        <!-- Centro -->
        <label for="centro">Centro de formación</label>
        <select name="centro" id="centro" required>
            <option value="">Selecciona centro de formación</option>
            {% for centro in centros %}
                <option value="{{ centro.id_centro }}" {% if borrador and borrador.centro and borrador.centro.id_centro == centro.id_centro %}selected{% endif %}>
                    {{ centro.nombre }}
                </option>
            {% endfor %}
        </select>
        <br>

        <!-- Programa -->
        <label for="programa">Programa</label>
        <select name="programa" id="programa" data-selected="{% if borrador and borrador.programa %}{{ borrador.programa.id_programa }}{% endif %}" required>
            <option value="">Seleccione un programa</option>
        </select>
        <br>


        <!-- Ficha -->
        <label for="ficha">Ficha</label>
        <div class="form-group">
          <input type="number" id="ficha" name="ficha" step="1" min="0" required placeholder="" value="{{ borrador.ficha|default:'' }}">
          <label for="ficha">Digite su ficha</label>
        </div>
        <br>

        <!-- Detalles -->
        <label for="detalles">Detalles de personalización adicionales</label>
        <br>
        <div class="form-group">
          <textarea type="text" id="detalles" name="detalles" maxlength="500" placeholder="">{{ borrador.detalles|default:'' }}</textarea>
          <label for="detalles">Escribe aquí tus detalles específicos</label>
        </div>

        <hr>
        <!-- Botón de envío -->
        <button type="submit">Enviar solicitud</button>
      </form>



      <!-- Modal de confirmación -->
      <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
          <h2>Solicitud enviada con éxito</h2>
          <p>Tu solicitud ha sido registrada y el borrador se eliminó.</p>
          <button id="cerrarModal">Cerrar</button>
        </div>
      </div>

    </div>
  </div>

{% endblock %}

{% block scripts %}
  <!-- Script del carrusel -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const slides = Array.from(document.querySelectorAll('.carousel .slide'));
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const carousel = document.querySelector('.carousel');

      if (!slides.length || !prevBtn || !nextBtn || !carousel) return;

      let current = 0;
      let autoInterval = null;
      const AUTO_DELAY = 6000; // ms

      function showSlide(index) {
        const idx = ((index % slides.length) + slides.length) % slides.length; // normalize
        slides.forEach((slide, i) => {
          const active = i === idx;
          slide.classList.toggle('active', active);
          slide.setAttribute('aria-hidden', (!active).toString());
        });
        current = idx;
      }

      function startAuto() {
        stopAuto();
        autoInterval = setInterval(() => showSlide(current + 1), AUTO_DELAY);
      }

      function stopAuto() {
        if (autoInterval) {
          clearInterval(autoInterval);
          autoInterval = null;
        }
      }

      // botones
      prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showSlide(current - 1);
        startAuto(); // reinicia autoplay al interactuar
      });

      nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showSlide(current + 1);
        startAuto();
      });

      // soporte teclado (flechas)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { showSlide(current - 1); startAuto(); }
        if (e.key === 'ArrowRight') { showSlide(current + 1); startAuto(); }
      });

      // pausa al pasar el ratón y reanuda al salir
      carousel.addEventListener('mouseenter', stopAuto);
      carousel.addEventListener('mouseleave', startAuto);

      // Iniciar mostrando la primera diapositiva y el autoplay
      showSlide(0);
      startAuto();
    });
  </script>


  <!-- Script para cargar programas bergen el centro seleccionado -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const centroSelect = document.getElementById('centro');
        const programaSelect = document.getElementById('programa');

        function cargarProgramas() {
            const centroId = centroSelect.value;
            programaSelect.innerHTML = '<option value="">Seleccione un programa</option>';
            if (!centroId) return;

            fetch(`/aprendiz/ajax/programas_por_centro/?centro_id=${centroId}`)
                .then(res => res.json())
                .then(data => {
                    data.programas.forEach(prog => {
                        const option = document.createElement('option');
                        option.value = prog.id_programa;
                        option.textContent = prog.nombre;
                        programaSelect.appendChild(option);
                    });

                    // Seleccionar el programa del borrador si existe
                    const selectedPrograma = programaSelect.dataset.selected;
                    if (selectedPrograma) {
                        programaSelect.value = selectedPrograma;
                    }
                });
        }

        centroSelect.addEventListener('change', () => {
            cargarProgramas();
        });

        // Cargar al iniciar si ya hay centro seleccionado en el borrador
        if (centroSelect.value) cargarProgramas();
    });
  </script>


  
  <!-- Script para manejar el tamaño del textarea automaticamente -->
  <script>
    const textarea = document.getElementById('detalles');

    textarea.addEventListener('input', () => {
        // Reinicia la altura para que el scrollHeight sea preciso
        textarea.style.height = 'auto';
        // Establece la altura al valor de scrollHeight del contenido
        textarea.style.height = textarea.scrollHeight + 'px';
    });
  </script>

{% endblock %}